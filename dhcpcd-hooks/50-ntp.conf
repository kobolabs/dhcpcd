# Sample dhcpcd hook script for ntp

# Detect OpenRC or BSD rc
# Distributions may want to just have their command here instead of this
if type rc-service >/dev/null 2>&1 && rc-service --exists ntpd; then
	ntpd_restart_cmd="rc-service ntpd -- --ifstarted --quiet restart"
elif [ -x /etc/rc.d/ntpd ]; then
	ntpd_restart_cmd="/etc/rc.d/ntpd restart"
elif [ -x /usr/local/etc/rc.d/ntpd ]; then
	ntpd_restart_cmd="/usr/local/etc/rc.d/ntpd restart"
fi

do_ntp_conf()
{
	local cf=/etc/ntp.conf."${interface}" x= m1= m2=
	local sig="# Generated by dhcpcd for interface"
	local sig_end="# End of dhcpcd content for interface"

	if [ -f /etc/ntp.conf ]; then
		# Remove our old entry
		m1="^${sig} ${interface}$"
		m2="^${sig_end} ${interface}$"
		sed "/${m1}/,/${m2}/d" /etc/ntp.conf > "${cf}"
		# Remove stale entries
		m1="^${sig} "
		for x in $(sed -n "s/${m1}//p" "${cf}"); do
			if [ ! -s /var/run/dhcpcd-${x}.pid ]; then
				m1="^${sig} ${x}$"
				m2="^${sig_end} ${x}$"
				sed "/${m1}/,/${m2}/d" "${cf}" >"${cf}".tmp
				mv -f "${cf}".tmp "${cf}"
			fi
		done
	else
		rm -f "${cf}"
	fi
	if [ "$1" = "add" -a -n "${new_ntp_servers}" ]; then
		echo "${sig} ${interface}" >> "${cf}"
		for x in ${new_ntp_servers}; do
			echo "server ${x}" >> "${cf}"
		done
		echo "${sig_end} ${interface}" >> "${cf}"
	fi
	if [ -f "${cf}" ]; then
		mv -f "${cf}" /etc/ntp.conf
		[ -n "${ntpd_restart_cmd}" ] && ${ntpd_restart_cmd}
	fi
}

case "${reason}" in
BOUND|INFORM|REBIND|REBOOT|RENEW|TIMEOUT)	do_ntp_conf add;;
EXPIRE|FAIL|IPV4LL|RELEASE|STOP)		do_ntp_conf del;;
esac
